<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Freehex</title>

    <style>* {padding: 0; margin: 0}</style>
</head>
<body>
<script src="node_modules/pixi.js/dist/pixi.js"></script>

<script>
  const renderer = PIXI.autoDetectRenderer(window.innerWidth, window.innerHeight,{antialias: true});
  renderer.view.style.position = "absolute";
  renderer.view.style.display = "block";
  renderer.autoResize = true;

  document.body.appendChild(renderer.view);
  const stage = new PIXI.Container();
  const mainStage = new PIXI.Container();
  stage.addChild(mainStage);

  const lineWidth=window.innerWidth+400;
  const lineHeight=window.innerHeight+400;
  const hexWidth=54;
  const hexHeight=46;

  function getHexPath(hexagonRadius,hexagonHeight) {
    return [
      -hexagonRadius, 0,
      -hexagonRadius/2, hexagonHeight/2,
      hexagonRadius/2, hexagonHeight/2,
      hexagonRadius, 0,
      hexagonRadius/2, -hexagonHeight/2,
      -hexagonRadius/2, -hexagonHeight/2,
    ];
  }

  const hex = new PIXI.Graphics();
  hex.beginFill(0x666666);

  const hexagonRadius=hexWidth/2;
  const hexagonHeight=hexHeight;
  hex.drawPolygon(getHexPath(hexagonRadius,hexagonHeight));
  hex.endFill();


  const hexes=[];
  let columnType=0;
  for(let x=-200+hexWidth;x<lineWidth;x+=hexWidth-9) {
    for(let y=-200+(columnType===0 ? (hexHeight+8)/2 : hexHeight+8);y<lineHeight;y+=hexHeight+8) {

      const myHex=hex.clone();

      myHex.x = x;
      myHex.y = y;

      mainStage.addChild(myHex);
      hexes.push(myHex);
    }

    columnType=columnType===0 ? 1 : 0;
  }


  function changeHexState(hex,state) {
    if(hex.state === state)
      return;
    hex.state=state;
    if(state==="empty") {
      hex.clear();
      hex.beginFill(0x666666);
      hex.drawPolygon(getHexPath(hexagonRadius,hexagonHeight));
      hex.endFill();
    }
    if(state==="going") {
      hex.clear();
      hex.beginFill(0x660000);
      hex.drawPolygon(getHexPath(hexagonRadius+3,hexagonHeight+3));
      hex.endFill();
      hex.beginFill(0x666666);
      hex.drawPolygon(getHexPath(hexagonRadius,hexagonHeight));
      hex.endFill();
    }
    if(state==="full") {

    }
  }

  const circle = new PIXI.Graphics();
  circle.beginFill(0x9966FF);
  circle.drawCircle(0, 0, 23);
  circle.endFill();
  circle.x = window.innerWidth/2;
  circle.y = window.innerHeight/2;
  stage.addChild(circle);

  const marker = new PIXI.Graphics();
  const point = new PIXI.Point(circle.x-mainStage.x, circle.y-mainStage.y);
  marker.clear().beginFill(0xffd900);
  marker.lineStyle(20, 0xffd900, 1);
  marker.moveTo(point.x, point.y);
  marker.lineTo(point.x, point.y);
  oldPoint = oldMidPoint = point;

  mainStage.addChild(marker);

  stage.interactive = true;

  let pos;
  stage.on("mousemove", (e) =>  {
    pos=e.data.getLocalPosition(stage);

  });
  const v=3;
  const go=true;

  function play() {

    if(pos && go) {
      const a=pos.x - circle.x;
      const b=pos.y - circle.y;
      const c=Math.sqrt(a*a+b*b);
      const x=a/c;
      const y=b/c;
      mainStage.x -= v*x;
      mainStage.y -= v*y;

      const point = new PIXI.Point(circle.x-mainStage.x, circle.y-mainStage.y);
      const midPoint = new PIXI.Point(oldPoint.x + point.x >> 1, oldPoint.y + point.y >> 1);
      marker.moveTo(midPoint.x, midPoint.y);
      marker.quadraticCurveTo(oldPoint.x, oldPoint.y, oldMidPoint.x, oldMidPoint.y);

      oldMidPoint = midPoint;
      oldPoint = point;

      checkCollision();
    }
  }


  function checkCollision() {
    hexes.forEach(hex => {
      if(hex.containsPoint(new PIXI.Point(circle.x,circle.y))) {

        console.log("I have been breached at",hex.x,hex.y);
        console.log(new PIXI.Point(circle.x-mainStage.x,circle.y-mainStage.y));

        changeHexState(hex,"going");

      }
    })
  }

  let state;

  state=play;

  function gameLoop() {
    requestAnimationFrame(gameLoop);
    state();
    renderer.render(stage);
  }

  gameLoop();
</script>
</body>
</html>